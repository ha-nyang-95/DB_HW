# Document API Upsert 기능 확인

📘 1\. 실습 주제 개요
---------------

### 🔎 실습 주제: **Elasticsearch의 Upsert 기능 이해 및 구현**

### 📌 실습 목적

이번 실습의 목적은 Elasticsearch에서 자주 사용되는 문서 갱신 패턴인 **Upsert**(Update or Insert) 동작을 이해하고, 이를 코드로 구현해보는 것이다. Upsert는 지정된 문서가 존재할 경우 해당 내용을 업데이트하고, 존재하지 않을 경우 새로운 문서를 삽입하는 기능으로, **데이터 적재와 갱신의 경계가 모호한 경우 매우 유용하게 사용된다.**

### 🎯 왜 배우는가?

*   Elasticsearch는 단순 검색뿐 아니라 대용량 문서 기반의 실시간 분석 시스템에서도 활용된다.
    
*   실제 서비스에서는 동일한 ID에 대해 값이 갱신되거나 없으면 삽입해야 할 상황이 빈번하게 발생한다. 예를 들어, 제품 가격이 변경되었을 때 기존 문서가 있으면 수정하고, 없으면 신규 등록해야 한다.
    
*   Upsert는 이와 같은 요구사항을 단일 API 호출로 해결함으로써 **코드의 복잡성과 서버 요청 횟수를 줄여준다.**
    

<br>
<br>

🛠️ 2\. 코드 구조 및 흐름 해설
---------------------

### 전체 흐름 개요

```text
1. 문서 삭제 시도 → 2. Upsert 실행 → 3. 문서 조회
```

### 각 단계 설명

#### ✅ 1단계: 기존 문서 삭제

```python
es.delete(index=index_name, id=doc_id)
```

*   **목적**: 문서를 먼저 삭제함으로써 이후 upsert 동작이 \*\*'삽입'\*\*으로 수행되도록 환경을 초기화함.
    
*   **예외 처리**: 삭제 대상 문서가 존재하지 않을 수도 있기 때문에, `NotFoundError` 예외를 처리함으로써 실습 흐름을 유지함.
    

#### ✅ 2단계: Upsert 수행

```python
es.update(index=index_name, id=doc_id, body={
    "doc": { "price": 999.99 },
    "doc_as_upsert": True
})
```

*   **핵심 구문**: `doc_as_upsert: True`는 문서가 없을 경우 `doc` 필드를 새로운 문서로 간주해 **삽입(insert)** 하도록 설정함.
    
*   **기능 요약**:
    
    *   존재하면 → `doc`의 내용으로 업데이트.
        
    *   없으면 → `doc`의 내용으로 문서를 새로 생성.
        

#### ✅ 3단계: 문서 조회

```python
es.get(index=index_name, id=doc_id)
```

*   **목적**: 실제로 문서가 삽입되었는지 확인함.
    
*   **출력**: `_source` 필드를 통해 저장된 JSON 내용을 직접 확인.
    
<br>
<br>

⚙️ 3\. 전체 코드 + 상세 주석
--------------------

```python
from elasticsearch import Elasticsearch, NotFoundError

# Elasticsearch 클라이언트 생성
# localhost:9200에 열려 있는 ES 서버에 연결
es = Elasticsearch("http://localhost:9200")

# 사용할 인덱스 및 문서 ID 설정
index_name = "products"
doc_id = 1

# 1. 기존 문서 삭제 - upsert 테스트를 위한 초기화 단계
try:
    es.delete(index=index_name, id=doc_id)
    print("1. 기존 문서 삭제 완료 (업서트 테스트 준비)")
except NotFoundError:
    # 문서가 없을 경우 예외 발생 → 실습 흐름 유지
    print("1. 삭제할 문서가 없음 (이미 삭제된 상태)")

# 2. Upsert 실행 - 문서가 없으면 새로 삽입되고, 있으면 업데이트
upsert_body_1 = {
    "doc": {
        "price": 999.99  # 변경 또는 삽입할 필드
    },
    "doc_as_upsert": True  # doc을 새 문서로 사용하도록 지정
}

response_1 = es.update(index=index_name, id=doc_id, body=upsert_body_1)
print("2. 업서트 (없으면 삽입):", response_1["result"])
# result는 'created' 또는 'updated' 값을 가짐

# 3. 문서 조회 - 실제 문서가 잘 들어갔는지 확인
doc = es.get(index=index_name, id=doc_id)
print("3. 문서 내용:", doc["_source"])  # 저장된 문서의 본문 출력
```

<br>

📚 4\. 추가 설명 및 실무 팁
-------------------

### 💡 실무에서 자주 하는 실수

| 실수 유형                | 설명 및 예시                                                                                                                                                                                |
| ------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **doc\_as\_upsert 생략** | 기본적으로 `update()`는 문서가 없으면 에러가 발생한다. 따라서 upsert 목적이라면 반드시 `"doc_as_upsert": True` 옵션을 명시해야 한다.                                                        |
| **스키마 오류**          | 삽입하려는 필드의 타입이 기존 문서와 다르면 mapping conflict로 인한 오류가 발생할 수 있다. 예: 기존에 `"price": 1000` (숫자)인데, `{"price": "expensive"}` (문자열)로 업데이트 시도 시 에러 |
| **버전 충돌**            | 동시성 처리를 하지 않으면 다중 클라이언트 환경에서 version conflict가 발생할 수 있다. Elasticsearch는 내부적으로 `_version`으로 충돌을 방지함.                                              |

### 🚀 실무 활용 팁

| 팁 항목                | 활용 내용                                                                                                           |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------- |
| **재고/가격 변경 API** | 전자상거래 시스템에서 특정 상품의 가격, 재고, 상태 정보를 업데이트할 때 upsert는 빠르고 안전한 방식                 |
| **로그 기반 보정**     | 시스템 상태 로그에서 누락된 항목이 발견될 때, 기존 상태를 보존하며 새 필드를 삽입하는 방식으로 안전하게 upsert 가능 |
| **통계 데이터 수집**   | 동일 문서 ID에 대해 시간별 통계를 업데이트하거나 새로 추가할 때 유용함 (`scripted upsert` 활용 시 더욱 강력)        |

<br>

🧭 마무리 요약
---------

이번 실습을 통해 우리는 Elasticsearch에서 자주 활용되는 `upsert` 기능을 실습하였고, 다음 내용을 명확히 이해하였다:

*   `update()`는 기본적으로 존재하는 문서만 수정할 수 있다.
    
*   `doc_as_upsert=True`를 지정하면, 존재하지 않는 문서는 자동으로 삽입된다.
    
*   실무에서는 데이터 중복, 동시성, 예외 처리 등을 고려해야 안정적인 시스템을 구성할 수 있다.
    